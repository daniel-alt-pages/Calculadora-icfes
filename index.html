<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Diagn칩stico Premium - SEAMOSGENIOS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            /* --- Colores Tema Oscuro (Default) --- */
            --bg-primary: #0f172a; /* Slate 900 */
            --bg-secondary: rgba(30, 41, 59, 0.7); /* Slate 800 with alpha */
            --bg-tertiary: #334155; /* Slate 700 */
            --text-primary: #f8fafc; /* Slate 50 */
            --text-secondary: #94a3b8; /* Slate 400 */
            --accent-color: #6366f1; /* Indigo 500 */
            --accent-hover: #4f46e5; /* Indigo 600 */
            --border-color: rgba(51, 65, 85, 0.7); /* Slate 700 with alpha */
            --shadow-color: rgba(99, 102, 241, 0.1);
        }

        html.light {
            /* --- Colores Tema Claro --- */
            --bg-primary: #f1f5f9; /* Slate 100 */
            --bg-secondary: rgba(255, 255, 255, 0.7);
            --bg-tertiary: #e2e8f0; /* Slate 200 */
            --text-primary: #0f172a; /* Slate 900 */
            --text-secondary: #475569; /* Slate 600 */
            --border-color: rgba(226, 232, 240, 0.7); /* Slate 200 with alpha */
        }

        html { scroll-behavior: smooth; }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-primary); 
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
        }
        
        /* --- Efecto Glassmorphism y Estilos de Tarjeta --- */
        .card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px var(--shadow-color);
            border-color: var(--accent-color);
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 50% 0%, var(--glow-color, rgba(255,255,255,0)), transparent 40%);
            opacity: 0;
            transition: opacity 0.5s ease;
            pointer-events: none;
        }
        .card:hover::before {
            opacity: 0.2;
        }

        /* --- Estilos de Componentes --- */
        .number-input-button { background-color: var(--bg-tertiary); }
        .number-input { background-color: var(--bg-secondary); border: 1px solid var(--border-color); }
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex; align-items: center; justify-content: center;
            z-index: 50; opacity: 0; transition: opacity 0.3s ease; pointer-events: none;
            backdrop-filter: blur(4px);
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-content { 
            background-color: var(--bg-primary); 
            border: 1px solid var(--border-color);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-overlay.active .modal-content { transform: scale(1); }
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="w-full">

    <div class="container mx-auto p-4 lg:p-8 max-w-screen-2xl">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <aside class="lg:col-span-3 lg:sticky top-8 h-max space-y-8">
                <div class="text-center">
                    <img src="https://i.ibb.co/SDVC1ssP/Copia-de-Seamos-Genios-20241115-011133-0000.png" alt="Logo SEAMOSGENIOS" class="mx-auto h-20 mb-4 rounded-2xl">
                    <h1 class="text-2xl font-black">Diagn칩stico Premium</h1>
                    <p class="text-sm" style="color: var(--text-secondary);">SEAMOSGENIOS COLOMBIA</p>
                </div>

                <div class="card p-6 rounded-2xl text-center">
                    <h2 class="text-lg font-bold mb-4">Puntaje Global</h2>
                    <div class="relative w-40 h-40 mx-auto flex items-center justify-center">
                        <div id="global-score-circle" style="position: absolute; width: 100%; height: 100%; border-radius: 50%; background: conic-gradient(var(--accent-color) 0deg, var(--bg-tertiary) 0deg); transition: background 0.8s ease-out;"></div>
                        <span id="global-score-value" class="text-5xl font-extrabold z-10">0</span>
                    </div>
                    <div id="global-feedback" class="mt-4 text-sm font-medium"></div>
                </div>

                <div class="card p-6 rounded-2xl">
                    <h2 class="text-lg font-bold mb-4">Resumen R치pido</h2>
                    <div class="space-y-3">
                        <div>
                            <h3 class="text-sm font-semibold text-green-400">츼rea m치s Fuerte</h3>
                            <p id="strongest-area" class="font-bold text-lg">--</p>
                        </div>
                        <div>
                            <h3 class="text-sm font-semibold text-red-400">츼rea a Mejorar</h3>
                            <p id="weakest-area" class="font-bold text-lg">--</p>
                        </div>
                    </div>
                </div>

                <div class="card p-6 rounded-2xl">
                     <h2 class="text-lg font-bold mb-4">Acciones</h2>
                     <div class="flex flex-col space-y-3">
                         <button id="reset-all-btn" class="w-full bg-red-600/80 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors">Reiniciar Todo</button>
                         <button id="save-report-btn" class="w-full text-white font-semibold py-2 px-4 rounded-lg transition-colors" style="background-color: var(--accent-color); hover:background-color: var(--accent-hover);">Guardar Reporte</button>
                     </div>
                </div>
            </aside>

            <main class="lg:col-span-9 space-y-8">
                <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                    <div class="card p-6 rounded-2xl fade-in">
                        <h2 class="text-xl font-bold mb-4 text-center">Perfil de Desempe침o</h2>
                        <div class="relative h-80 w-full"><canvas id="performanceChart"></canvas></div>
                    </div>
                    <div class="card p-6 rounded-2xl fade-in flex flex-col" style="animation-delay: 0.1s;">
                        <div class="flex justify-center items-center gap-2 mb-4">
                            <h2 class="text-xl font-bold text-center">Comparativa Nacional (2024)</h2>
                            <button id="info-comparison-btn" class="w-6 h-6 rounded-full flex items-center justify-center" style="background-color: var(--bg-tertiary);">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                  <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                        <div class="relative h-80 w-full flex-grow"><canvas id="comparisonChart"></canvas></div>
                        <a href="https://www.javeriana.edu.co/recursosdb/d/lee/inf-114-informe-saber-11-2025-lee" target="_blank" rel="noopener noreferrer" class="mt-4 text-center text-xs hover:underline" style="color: var(--text-secondary);">
                            Fuente: Lab. de Econom칤a de la Educaci칩n (LEE) - U. Javeriana
                        </a>
                    </div>
                </div>

                <div id="calculator-section" class="fade-in" style="animation-delay: 0.2s;">
                    <h2 class="text-2xl font-bold mb-6">Calculadora de Puntajes por 츼rea</h2>
                    <div id="calculator" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-6"></div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Bot칩n Flotante de Tema -->
    <button id="theme-toggle" class="fixed bottom-5 right-5 z-50 w-14 h-14 rounded-full shadow-lg flex items-center justify-center transition-transform hover:scale-110" style="background-color: var(--bg-tertiary);">
        <svg id="theme-icon-light" class="w-7 h-7 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.121-3.536a1 1 0 010 1.414l-.707.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM10 18a1 1 0 01-1-1v-1a1 1 0 112 0v1a1 1 0 01-1 1zm-4.95-2.464A1 1 0 013.636 14.12l.707.707a1 1 0 01-1.414 1.414l-.707-.707a1 1 0 010-1.414zM1.464 8.536a1 1 0 011.414 0l.707.707a1 1 0 11-1.414 1.414l-.707-.707a1 1 0 010-1.414zM4.95 6.364a1 1 0 00-1.414-1.414l-.707.707a1 1 0 001.414 1.414l.707-.707z"></path></svg>
        <svg id="theme-icon-dark" class="w-7 h-7" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
    </button>
    
    <div id="toast" class="fixed bottom-24 right-5 bg-green-500 text-white py-2 px-5 rounded-lg shadow-xl opacity-0 translate-y-5 transition-all duration-300">Reporte copiado</div>
    
    <!-- Modales -->
    <div id="detail-modal" class="modal-overlay">
        <div class="modal-content p-6 rounded-2xl transform scale-95 transition-transform duration-300">
             <div id="modal-header" class="flex justify-between items-center mb-4">
                <h2 id="modal-title" class="text-2xl font-bold">Detalles del Nivel</h2>
                <button id="close-modal-btn" class="text-3xl font-bold leading-none">&times;</button>
            </div>
            <div id="modal-body"></div>
        </div>
    </div>
    <div id="info-modal" class="modal-overlay">
        <div class="modal-content p-6 rounded-2xl transform scale-95 transition-transform duration-300">
             <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">쯈u칠 significa cada promedio?</h2>
                <button id="close-info-modal-btn" class="text-3xl font-bold leading-none">&times;</button>
            </div>
            <div class="space-y-4 text-sm" style="color: var(--text-secondary);">
                <p><strong class="font-bold" style="color: var(--text-primary);">Promedio C. P칰blicos:</strong> Es el puntaje promedio obtenido por estudiantes de colegios p칰blicos. Te sirve como referencia si estudias en uno de ellos.</p>
                <p><strong class="font-bold" style="color: var(--text-primary);">Promedio C. Privados:</strong> Es el puntaje promedio de los estudiantes de colegios privados. Hist칩ricamente, este promedio tiende a ser m치s alto.</p>
                <p>Compararte con ambos te da una visi칩n m치s completa y justa de tu rendimiento, permiti칠ndote establecer metas m치s realistas seg칰n tu contexto.</p>
            </div>
        </div>
    </div>
    
    <script>
        // --- L칍GICA DE LA APLICACI칍N ---
        const performanceDetails = {
            lectura: {
                1: { title: "Nivel 1 (0-35)", general: "Identifica elementos literales en textos continuos y discontinuos sin establecer relaciones.", evidences: ["Reconoce informaci칩n expl칤cita.", "Localiza p치rrafos y enunciados; distingue proposici칩n de p치rrafo."] },
                2: { title: "Nivel 2 (36-50)", general: "Adem치s del nivel 1, comprende textos de forma literal y reconoce relaciones b치sicas.", evidences: ["Identifica estructura textual.", "Encuentra sin칩nimos, ant칩nimos.", "Detecta intenci칩n comunicativa.", "Reconoce relaciones de contraste, similitud, complementaci칩n.", "Percibe sentido local/global."] },
                3: { title: "Nivel 3 (51-65)", general: "Interpreta informaci칩n impl칤cita, distingue estructuras, estrategias y valora argumentos.", evidences: ["Jerarquiza informaci칩n.", "Realiza inferencias en textos continuos y discontinuos.", "Reconoce relaciones causa-efecto, oposici칩n, etc.", "Analiza marcadores textuales, figuras literarias y estructura sint치ctica.", "Sintetiza informaci칩n; eval칰a argumentos."] },
                4: { title: "Nivel 4 (66-100)", general: "Reflexiona cr칤ticamente sobre la visi칩n del autor, elementos paratextuales y aplica an치lisis literario.", evidences: ["Propone soluciones interpretativas.", "Eval칰a estrategias discursivas.", "Relaciona dos o m치s textos.", "Usa conceptos de an치lisis literario.", "Considera contexto socio-ideol칩gico.", "Construye argumentos propios; asume postura cr칤tica.", "Formula hip칩tesis de lectura."] }
            },
            matematicas: {
                1: { title: "Nivel 1 (0-35)", general: "Interpreta informaci칩n puntual y situaciones cotidianas; identifica la tarea.", evidences: ["Lectura directa de datos num칠ricos y operaciones sencillas."] },
                2: { title: "Nivel 2 (36-50)", general: "Diferencia posibles procedimientos; asocia conceptos b치sicos y patrones.", evidences: ["Selecci칩n de procedimientos matem치ticos adecuados a problemas simples."] },
                3: { title: "Nivel 3 (51-70)", general: "Analiza alternativas y elige la mejor soluci칩n. Relaciona variables y convierte datos en conclusiones.", evidences: ["An치lisis de alternativas y elecci칩n de la mejor soluci칩n.", "Relaci칩n de variables y conversi칩n de datos en conclusiones."] },
                4: { title: "Nivel 4 (71-100)", general: "Deduce y combina conceptos, ecuaciones y procedimientos complejos.", evidences: ["Resoluci칩n de problemas nuevos mediante aplicaciones complejas.", "Modelado de fen칩menos y justificaci칩n de decisiones basadas en datos."] }
            },
            sociales: {
                1: { title: "Nivel 1 (0-40)", general: "Reconoce informaci칩n b치sica: hechos, datos sencillos.", evidences: ["Uso de conceptos elementales en contextos hist칩ricos y geogr치ficos."] },
                2: { title: "Nivel 2 (41-55)", general: "Comprende relaciones entre hechos; interpreta conceptos b치sicos.", evidences: ["Explicaci칩n de relaciones simples y contexto de eventos sociales."] },
                3: { title: "Nivel 3 (56-70)", general: "Analiza situaciones, relaciona fuentes, comprende argumentos e estructuras sociales.", evidences: ["Interpretaci칩n de m칰ltiples perspectivas y an치lisis de fen칩menos sociales."] },
                4: { title: "Nivel 4 (71-100)", general: "Conoce disposiciones constitucionales, eval칰a argumentos, propone soluciones aceptables socialmente.", evidences: ["Identificaci칩n de soluciones ciudadanas, argumentaci칩n en debates sociales."] }
            },
            ciencias: {
                1: { title: "Nivel 1 (0-40)", general: "Reconoce informaci칩n expl칤cita en gr치ficos/tablas.", evidences: ["Extracci칩n de datos directos sin interpretaci칩n profunda."] },
                2: { title: "Nivel 2 (41-55)", general: "Identifica patrones, relaciona esquemas, hace predicciones b치sicas.", evidences: ["Reconocimiento de tendencias cient칤ficas a nivel b치sico."] },
                3: { title: "Nivel 3 (56-70)", general: "Interrelaciona conceptos y leyes, distingue evidencia vs. conclusi칩n y plantea hip칩tesis.", evidences: ["An치lisis cr칤tico de datos emp칤ricos y formulaci칩n de hip칩tesis."] },
                4: { title: "Nivel 4 (71-100)", general: "Aplica conceptos, teor칤as y leyes para resolver situaciones complejas.", evidences: ["Argumentaci칩n cient칤fica y justificaci칩n de soluciones."] }
            },
            ingles: {
                1: { title: "Nivel A- (0-47)", general: "Por debajo de A1. Vocabulario y estructuras muy b치sicos.", evidences: ["No alcanza el nivel m칤nimo para ser clasificado en A1."] },
                2: { title: "Nivel A1 (48-57)", general: "Comprende y utiliza expresiones cotidianas y frases muy sencillas.", evidences: ["Puede presentarse a s칤 mismo y a otros, pedir y dar informaci칩n personal b치sica."] },
                3: { title: "Nivel A2 (58-67)", general: "Comprende frases y expresiones de uso frecuente relacionadas con 치reas de experiencia que son de importancia inmediata.", evidences: ["Puede comunicarse en tareas simples y habituales que requieren un intercambio simple y directo de informaci칩n."] },
                4.5: { title: "Nivel B1 (68-78)", general: "Es capaz de comprender los puntos principales de textos claros y en lengua est치ndar si tratan sobre cuestiones que le son conocidas.", evidences: ["Sabe desenvolverse en la mayor parte de las situaciones que pueden surgir durante un viaje.", "Es capaz de producir textos sencillos y coherentes sobre temas que le son familiares."] },
                5: { title: "Nivel B+ (79-100)", general: "Supera el nivel B1. Es capaz de entender las ideas principales de textos complejos.", evidences: ["Puede relacionarse con hablantes nativos con un grado suficiente de fluidez y naturalidad.", "Puede producir textos claros y detallados sobre temas diversos."] }
            }
        };
        const scoreLookupTable = {
            lectura:     [100, 80, 78, 75, 72, 69, 66, 63, 60, 57, 54, 51, 49, 46, 43, 40, 37, 34, 31, 29, 26, 23, 21, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20],
            matematicas: [100, 82, 80, 77, 76, 73, 69, 67, 66, 65, 63, 62, 60, 59, 57, 56, 55, 53, 52, 51, 49, 48, 47, 45, 44, 42, 41, 40, 38, 37, 36, 34, 33, 32, 30, 30, 30, 30, 30, 30, 30, 30],
            sociales:    [100, 82, 80, 77, 76, 73, 69, 67, 66, 65, 63, 62, 60, 59, 57, 56, 55, 53, 52, 51, 49, 48, 47, 45, 44, 42, 41, 40, 38, 37, 36, 34, 33, 32, 30, 30, 30, 30, 30, 30, 30, 30],
            ciencias:    [100, 81, 80, 77, 76, 73, 69, 67, 66, 65, 63, 62, 60, 59, 57, 56, 55, 53, 52, 51, 49, 48, 47, 45, 44, 42, 41, 40, 38, 37, 36, 34, 33, 32, 30, 30, 30, 30, 30, 30, 30, 30],
            ingles:      [100, 83, 80, 77, 76, 73, 69, 64, 66, 65, 63, 62, 60, 59, 57, 56, 55, 53, 52, 51, 49, 48, 47, 45, 44, 42, 41, 40, 38, 37, 36, 34, 33, 32, 30, 30, 30, 30, 30, 30, 30, 30]
        };
        const subjects = [
            { id: 'matematicas', name: 'Matem치ticas', emoji: '游빑', color: '#3b82f6' },
            { id: 'lectura', name: 'Lectura', emoji: '游닀', color: '#ef4444' },
            { id: 'sociales', name: 'Sociales', emoji: '游', color: '#8b5cf6' },
            { id: 'ciencias', name: 'Ciencias', emoji: '游댧', color: '#22c55e' },
            { id: 'ingles', name: 'Ingl칠s', emoji: '游깴', color: '#6366f1' }
        ];
        // DATOS REALES 2024
        const nationalAverages = { matematicas: 52.2, lectura: 53.4, sociales: 49.2, ciencias: 51.1, ingles: 51.9 };
        const officialAverages = { matematicas: 50.1, lectura: 51.5, sociales: 47.1, ciencias: 49.0, ingles: 49.5 };
        const nonOfficialAverages = { matematicas: 58.5, lectura: 59.8, sociales: 55.4, ciencias: 57.3, ingles: 58.9 };
        
        const weights = { matematicas: 3, lectura: 3, sociales: 3, ciencias: 3, ingles: 1 };
        let currentScores = {};
        let performanceChart, comparisonChart;

        document.addEventListener('DOMContentLoaded', () => {
            initializeTheme();
            initializeCalculator();
            initializeCharts();
            initializeActionButtons();
            initializeModal();
            updateAll(true);
        });

        function initializeTheme() {
            const toggle = document.getElementById('theme-toggle');
            const lightIcon = document.getElementById('theme-icon-light');
            const darkIcon = document.getElementById('theme-icon-dark');
            
            const updateThemeUI = () => {
                const isLight = document.documentElement.classList.contains('light');
                lightIcon.classList.toggle('hidden', !isLight);
                darkIcon.classList.toggle('hidden', isLight);
            };

            toggle.addEventListener('click', () => {
                document.documentElement.classList.toggle('light');
                document.documentElement.classList.toggle('dark');
                updateThemeUI();
                updateChartColors();
            });
            updateThemeUI();
        }

        function initializeCalculator() {
            const container = document.getElementById('calculator');
            subjects.forEach((subject, index) => {
                currentScores[subject.id] = getScoreFromTable(0, subject.id);
                const card = createSubjectCard(subject);
                card.style.animationDelay = `${0.3 + index * 0.05}s`;
                if (subject.id === 'ingles') {
                    card.classList.add('sm:col-span-2', 'xl:col-span-4');
                }
                container.appendChild(card);
                const minusButton = card.querySelector('.minus-btn');
                const plusButton = card.querySelector('.plus-btn');
                minusButton.addEventListener('click', () => adjustErrors(subject.id, -1));
                plusButton.addEventListener('click', () => adjustErrors(subject.id, 1));

                card.querySelector(`#errors-${subject.id}`).addEventListener('input', (e) => handleInput(e, subject));
                card.querySelector(`#achieved-levels-btn-${subject.id}`).addEventListener('click', () => showDetailsModal(subject.id, 'achieved'));
                card.querySelector(`#missing-levels-btn-${subject.id}`).addEventListener('click', () => showDetailsModal(subject.id, 'missing'));
            });
        }

        function initializeCharts() {
            const radarCtx = document.getElementById('performanceChart').getContext('2d');
            performanceChart = new Chart(radarCtx, { type: 'radar', data: getRadarData(), options: getRadarOptions() });
            
            const barCtx = document.getElementById('comparisonChart').getContext('2d');
            comparisonChart = new Chart(barCtx, { type: 'bar', data: getBarData(), options: getBarOptions() });
        }
        
        function initializeActionButtons() {
            document.getElementById('reset-all-btn').addEventListener('click', () => {
                subjects.forEach(subject => {
                    const input = document.getElementById(`errors-${subject.id}`);
                    if (input.value !== '0') {
                        input.value = 0;
                        input.dispatchEvent(new Event('input'));
                    }
                });
            });
            document.getElementById('save-report-btn').addEventListener('click', saveReportToClipboard);
        }

        function initializeModal() {
            const detailModal = document.getElementById('detail-modal');
            document.getElementById('close-modal-btn').addEventListener('click', () => detailModal.classList.remove('active'));
            detailModal.addEventListener('click', (e) => { if (e.target === detailModal) detailModal.classList.remove('active'); });
            
            const infoModal = document.getElementById('info-modal');
            document.getElementById('info-comparison-btn').addEventListener('click', () => infoModal.classList.add('active'));
            document.getElementById('close-info-modal-btn').addEventListener('click', () => infoModal.classList.remove('active'));
            infoModal.addEventListener('click', (e) => { if (e.target === infoModal) infoModal.classList.remove('active'); });
        }

        function createSubjectCard(subject) {
            const card = document.createElement('div');
            card.className = 'card p-6 rounded-2xl shadow-lg flex flex-col fade-in';
            card.style.setProperty('--glow-color', subject.color);
            const maxErrors = scoreLookupTable[subject.id].length - 1;
            const initialScore = getScoreFromTable(0, subject.id);
            card.innerHTML = `
                <div class="relative z-10 flex flex-col h-full">
                    <h3 class="text-lg font-bold mb-4">${subject.emoji} ${subject.name}</h3>
                    <div class="flex items-center gap-2">
                        <button type="button" class="number-input-button minus-btn w-10 h-10 text-2xl rounded-md flex-shrink-0">-</button>
                        <input type="number" id="errors-${subject.id}" value="0" min="0" max="${maxErrors}" class="number-input w-full text-center h-10 rounded-md text-lg font-semibold" placeholder="Errores">
                        <button type="button" class="number-input-button plus-btn w-10 h-10 text-2xl rounded-md flex-shrink-0">+</button>
                    </div>
                    <div class="text-center my-4">
                        <span class="text-5xl font-extrabold" id="score-${subject.id}">${initialScore}</span>
                        <span style="color: var(--text-secondary);">/ 100</span>
                    </div>
                    <div class="mt-auto flex gap-2">
                        <button id="achieved-levels-btn-${subject.id}" class="w-full text-white font-semibold py-2 px-3 rounded-lg transition-all duration-300 text-sm bg-green-600/80 hover:bg-green-600"></button>
                        <button id="missing-levels-btn-${subject.id}" class="w-full text-white font-semibold py-2 px-3 rounded-lg transition-all duration-300 text-sm bg-red-600/80 hover:bg-red-600"></button>
                    </div>
                </div>
            `;
            return card;
        }

        function adjustErrors(subjectId, amount) {
            const input = document.getElementById(`errors-${subjectId}`);
            let val = (parseInt(input.value) || 0) + amount;
            val = Math.max(0, Math.min(val, parseInt(input.max)));
            input.value = val;
            input.dispatchEvent(new Event('input'));
        }

        function handleInput(event, subject) {
            const score = getScoreFromTable(parseInt(event.target.value) || 0, subject.id);
            currentScores[subject.id] = score;
            
            const scoreElement = document.getElementById(`score-${subject.id}`);
            if (scoreElement.textContent !== score.toString()) {
                 scoreElement.style.transform = 'scale(1.1)';
                 setTimeout(() => { scoreElement.textContent = score; scoreElement.style.transform = 'scale(1)'; }, 100);
            }
            updateAll(false);
        }

        function updateAll(isInitial) {
            updateGlobalScore(isInitial);
            updateSummary();
            updatePerformanceLevels();
            updateCharts();
        }
        
        function updateSummary() {
            const scoresArray = Object.entries(currentScores).map(([id, score]) => ({ id, score }));
            scoresArray.sort((a, b) => b.score - a.score);
            const strongest = subjects.find(s => s.id === scoresArray[0].id);
            const weakest = subjects.find(s => s.id === scoresArray[scoresArray.length - 1].id);
            document.getElementById('strongest-area').textContent = strongest.name;
            document.getElementById('weakest-area').textContent = weakest.name;
        }

        function updatePerformanceLevels() {
            subjects.forEach(subject => {
                const score = currentScores[subject.id];
                const currentLevelKey = getPerformanceLevel(subject.id, score);
                const allLevels = Object.keys(performanceDetails[subject.id]);

                const achievedLevels = allLevels.filter(level => parseFloat(level) <= parseFloat(currentLevelKey));
                const missingLevels = allLevels.filter(level => parseFloat(level) > parseFloat(currentLevelKey));

                const achievedBtn = document.getElementById(`achieved-levels-btn-${subject.id}`);
                const missingBtn = document.getElementById(`missing-levels-btn-${subject.id}`);

                if (achievedLevels.length > 0) {
                    achievedBtn.style.display = 'block';
                    achievedBtn.innerHTML = `Alcanzados (${achievedLevels.length})`;
                } else {
                    achievedBtn.style.display = 'none';
                }

                if (missingLevels.length > 0) {
                    missingBtn.style.display = 'block';
                    missingBtn.innerHTML = `Faltantes (${missingLevels.length})`;
                } else {
                    missingBtn.style.display = 'none';
                }

                if (achievedLevels.length > 0 && missingLevels.length > 0) {
                    achievedBtn.style.width = '50%';
                    missingBtn.style.width = '50%';
                } else if (achievedLevels.length > 0) {
                    achievedBtn.style.width = '100%';
                } else if (missingLevels.length > 0) {
                    missingBtn.style.width = '100%';
                }
            });
        }

        function calculateGlobalScore() {
            return Math.round(subjects.reduce((sum, s) => sum + currentScores[s.id] * weights[s.id], 0) / 13 * 5);
        }

        function updateGlobalScore(isInitial) {
            const finalScore = calculateGlobalScore();
            const scoreElement = document.getElementById('global-score-value');
            const circle = document.getElementById('global-score-circle');
            const feedbackElement = document.getElementById('global-feedback');

            const updateVisuals = (score) => {
                scoreElement.textContent = score;
                circle.style.background = `conic-gradient(var(--accent-color) ${score / 500 * 360}deg, var(--bg-tertiary) 0deg)`;
            };

            if (isInitial) {
                let startTimestamp = null;
                const animate = (timestamp) => {
                    if (!startTimestamp) startTimestamp = timestamp;
                    const progress = Math.min((timestamp - startTimestamp) / 1200, 1);
                    updateVisuals(Math.floor(progress * finalScore));
                    if (progress < 1) window.requestAnimationFrame(animate);
                    else {
                        updateVisuals(finalScore);
                        const feedback = getGlobalFeedback(finalScore);
                        feedbackElement.innerHTML = `<p class="${feedback.color} font-semibold">${feedback.message}</p>`;
                    }
                };
                window.requestAnimationFrame(animate);
            } else {
                updateVisuals(finalScore);
                const feedback = getGlobalFeedback(finalScore);
                feedbackElement.innerHTML = `<p class="${feedback.color} font-semibold">${feedback.message}</p>`;
            }
        }
        
        function getGlobalFeedback(score) {
            if (score > 400) return { message: "춰Excelente!", color: "text-green-400" };
            if (score > 350) return { message: "춰Muy Bien!", color: "text-blue-400" };
            if (score > 250) return { message: "Buen Comienzo", color: "text-yellow-400" };
            return { message: "A Mejorar", color: "text-red-400" };
        }
        
        function getScoreFromTable(e, s) { return scoreLookupTable[s][e] || scoreLookupTable[s].slice(-1)[0]; }
        
        function saveReportToClipboard() {
            let report = `--- REPORTE DE DIAGN칍STICO SEAMOSGENIOS ---\n`;
            report += `Puntaje Global Simulado: ${calculateGlobalScore()} / 500\n\n`;
            subjects.forEach(s => { report += `${s.name}: ${currentScores[s.id]} / 100\n`; });
            navigator.clipboard.writeText(report).then(() => {
                const toast = document.getElementById('toast');
                toast.style.opacity = '1';
                toast.style.transform = 'translateY(0)';
                setTimeout(() => { toast.style.opacity = '0'; toast.style.transform = 'translateY(1.25rem)'; }, 3000);
            });
        }
        
        function updateCharts() {
            if (!performanceChart || !comparisonChart) return;
            const scores = subjects.map(s => currentScores[s.id]);
            performanceChart.data.datasets[0].data = scores;
            comparisonChart.data.datasets[0].data = scores;
            comparisonChart.data.datasets[1].data = subjects.map(s => officialAverages[s.id]);
            comparisonChart.data.datasets[2].data = subjects.map(s => nonOfficialAverages[s.id]);
            performanceChart.update('none');
            comparisonChart.update('none');
        }
        
        function updateChartColors() {
            const isLight = document.documentElement.classList.contains('light');
            const textColor = isLight ? '#0f172a' : '#f8fafc';
            const gridColor = isLight ? 'rgba(0, 0, 0, 0.1)' : 'rgba(255, 255, 255, 0.1)';
            [performanceChart, comparisonChart].forEach(chart => {
                if (chart) {
                    chart.options.plugins.legend.labels.color = textColor;
                    if (chart.options.scales.r) {
                        chart.options.scales.r.pointLabels.color = textColor;
                        chart.options.scales.r.grid.color = gridColor;
                        chart.options.scales.r.angleLines.color = gridColor;
                        chart.options.scales.r.ticks.color = textColor;
                    }
                    if (chart.options.scales.x) chart.options.scales.x.ticks.color = textColor;
                    if (chart.options.scales.y) chart.options.scales.y.ticks.color = textColor;
                    chart.update('none');
                }
            });
        }

        function getChartBaseOptions() {
            const isLight = document.documentElement.classList.contains('light');
            return {
                responsive: true, maintainAspectRatio: false,
                plugins: { 
                    legend: { labels: { color: isLight ? '#0f172a' : '#f8fafc', boxWidth: 12, font: { size: 14 } } },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.7)',
                        titleColor: '#fff',
                        bodyColor: '#fff'
                    }
                }
            };
        }

        function getRadarOptions() {
            const opts = getChartBaseOptions();
            opts.scales = { r: { suggestedMin: 0, suggestedMax: 100, pointLabels: { font: { size: 14 } } } };
            return opts;
        }

        function getBarOptions() {
            const opts = getChartBaseOptions();
            opts.scales = { y: { beginAtZero: true }, x: {} };
            return opts;
        }

        function getRadarData() {
            return { labels: subjects.map(s => s.name), datasets: [{ label: 'Tu Puntaje', data: [], backgroundColor: 'rgba(99, 102, 241, 0.2)', borderColor: '#6366f1', borderWidth: 2 }] };
        }
        
        function getBarData() {
            return {
                labels: subjects.map(s => s.name),
                datasets: [
                    { label: 'Tu Puntaje', data: [], backgroundColor: subjects.map(s => s.color), borderRadius: 4 },
                    { label: 'Prom. C. P칰blicos', data: [], backgroundColor: 'rgba(239, 68, 68, 0.5)', borderRadius: 4 },
                    { label: 'Prom. C. Privados', data: [], backgroundColor: 'rgba(59, 130, 246, 0.5)', borderRadius: 4 }
                ]
            };
        }
        
        function getPerformanceLevel(subjectId, score) {
            switch (subjectId) {
                case 'lectura': if (score <= 35) return 1; if (score <= 50) return 2; if (score <= 65) return 3; return 4;
                case 'matematicas': if (score <= 35) return 1; if (score <= 50) return 2; if (score <= 70) return 3; return 4;
                case 'sociales': if (score <= 40) return 1; if (score <= 55) return 2; if (score <= 70) return 3; return 4;
                case 'ciencias': if (score <= 40) return 1; if (score <= 55) return 2; if (score <= 70) return 3; return 4;
                case 'ingles': if (score <= 47) return 1; if (score <= 57) return 2; if (score <= 67) return 3; if (score <= 78) return 4.5; return 5;
                default: return 1;
            }
        }
        
        function getLevelStyle(levelKey) {
            const levelNum = Math.floor(levelKey);
            if (levelNum === 4 || levelNum === 5) return { bgColor: 'rgba(59, 130, 246, 0.2)', textColor: '#60a5fa' }; // Blue
            if (levelNum === 3) return { bgColor: 'rgba(34, 197, 94, 0.2)', textColor: '#4ade80' }; // Green
            if (levelNum === 2) return { bgColor: 'rgba(234, 179, 8, 0.2)', textColor: '#facc15' }; // Yellow
            return { bgColor: 'rgba(239, 68, 68, 0.2)', textColor: '#f87171' }; // Red
        }

        function showDetailsModal(subjectId, type) {
            const score = currentScores[subjectId];
            const currentLevelKey = getPerformanceLevel(subjectId, score);
            const allLevels = Object.keys(performanceDetails[subjectId]);

            const relevantLevels = (type === 'achieved')
                ? allLevels.filter(level => parseFloat(level) <= parseFloat(currentLevelKey))
                : allLevels.filter(level => parseFloat(level) > parseFloat(currentLevelKey));

            const title = (type === 'achieved') ? 'Niveles Alcanzados' : 'Niveles Faltantes';
            document.getElementById('modal-title').textContent = `${title} en ${subjects.find(s=>s.id === subjectId).name}`;

            let modalBodyContent = '';
            if (relevantLevels.length === 0) {
                modalBodyContent = `<p style="color: var(--text-secondary);">No hay niveles en esta categor칤a.</p>`;
            } else {
                relevantLevels.forEach(levelKey => {
                    const details = performanceDetails[subjectId][levelKey];
                    const style = getLevelStyle(levelKey);
                    modalBodyContent += `
                        <div class="p-4 rounded-lg mb-4" style="background-color: ${style.bgColor}; border: 1px solid ${style.textColor};">
                            <p class="font-bold text-lg" style="color: ${style.textColor};">${details.title}</p>
                            <p class="text-sm mt-1" style="color: var(--text-secondary);">${details.general}</p>
                        </div>
                    `;
                });
            }

            document.getElementById('modal-body').innerHTML = modalBodyContent;
            document.getElementById('detail-modal').classList.add('active');
        }
    </script>
</body>
</html>
